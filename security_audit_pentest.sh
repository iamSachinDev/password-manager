#!/bin/bash
set -e

echo "üîê Adding Audit + Pentest infrastructure..."

# =========================
# AUDIT MODULE
# =========================

mkdir -p src/modules/audit

cat <<EOF > src/modules/audit/audit.types.ts
export type AuditEventType =
  | 'AUTH_LOGIN'
  | 'AUTH_LOGIN_FAILED'
  | 'VAULT_READ'
  | 'VAULT_UPDATE'
  | 'SECURITY_ALERT'
EOF

cat <<EOF > src/modules/audit/audit.repository.ts
import { Inject, Injectable } from '@nestjs/common'
import { Db } from 'mongodb'
import { AuditEventType } from './audit.types'

@Injectable()
export class AuditRepository {
  constructor(@Inject('MONGO_DB') private readonly db: Db) {}

  async log(
    userId: string | null,
    event: AuditEventType,
    metadata: Record<string, any> = {},
  ) {
    await this.db.collection('audit_logs').insertOne({
      userId,
      event,
      metadata,
      createdAt: new Date(),
    })
  }
}
EOF

cat <<EOF > src/modules/audit/audit.service.ts
import { Injectable } from '@nestjs/common'
import { AuditRepository } from './audit.repository'
import { AuditEventType } from './audit.types'

@Injectable()
export class AuditService {
  constructor(private readonly repo: AuditRepository) {}

  log(
    userId: string | null,
    event: AuditEventType,
    metadata?: Record<string, any>,
  ) {
    // üö´ NEVER log secrets, vaults, passwords
    return this.repo.log(userId, event, metadata)
  }
}
EOF

cat <<EOF > src/modules/audit/audit.module.ts
import { Module } from '@nestjs/common'
import { AuditService } from './audit.service'
import { AuditRepository } from './audit.repository'

@Module({
  providers: [AuditService, AuditRepository],
  exports: [AuditService],
})
export class AuditModule {}
EOF

echo "‚úÖ Audit module created."

# =========================
# SECURITY MIDDLEWARE
# =========================

mkdir -p src/security

cat <<EOF > src/security/security.middleware.ts
import { Request, Response, NextFunction } from 'express'

export function securityMiddleware(
  req: Request,
  _res: Response,
  next: NextFunction,
) {
  // Block suspicious payload sizes
  if (JSON.stringify(req.body || {}).length > 10_000) {
    throw new Error('Payload too large')
  }

  next()
}
EOF

# =========================
# PENTEST CHECKLIST
# =========================

cat <<EOF > PENTEST_CHECKLIST.md
# üî• Password Manager ‚Äì Pentest Checklist

## Authentication
- [ ] Brute force protection on login
- [ ] Timing attack resistance
- [ ] JWT expiration ‚â§ 1h
- [ ] Refresh token rotation

## Vault Security
- [ ] Vault payload never logged
- [ ] Vault never decrypted on server
- [ ] Encrypted payload versioned

## API Security
- [ ] Rate limiting enabled
- [ ] Helmet enabled
- [ ] CORS locked down
- [ ] Payload size limits

## MongoDB
- [ ] Auth enabled
- [ ] No public exposure
- [ ] Least privilege DB user

## Secrets
- [ ] No secrets in logs
- [ ] No secrets in env except config
- [ ] No master password anywhere

## Attack Simulations
- [ ] DB dump unreadable
- [ ] Server compromise safe
- [ ] Replay attack blocked
- [ ] JWT tampering detected
EOF

# =========================
# POSTMAN SECURITY TESTS
# =========================

cat <<EOF > postman_security_tests.md
# üß™ Postman Security Tests

## 1. Brute Force
- Repeated login attempts
- Expect 429 after threshold

## 2. Vault Tampering
- Modify ciphertext
- Expect 400 / authTag failure

## 3. JWT Tampering
- Modify token payload
- Expect 401

## 4. Payload Flood
- Send huge body
- Expect rejection

## 5. Unauthorized Access
- Remove token
- Expect 401
EOF

# =========================
# FINAL NOTES
# =========================

echo "üîê Security & Pentest setup completed."
echo "üìÑ Files added:"
echo "  - src/modules/audit/*"
echo "  - src/security/security.middleware.ts"
echo "  - PENTEST_CHECKLIST.md"
echo "  - postman_security_tests.md"
echo ""
echo "üëâ NEXT STEPS:"
echo "  1. Import AuditModule into AppModule"
echo "  2. Use AuditService inside Auth & Vault services"
echo "  3. Enable rate limiting + helmet"
